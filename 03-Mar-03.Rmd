## TIL20220321

### 가설검정

#### 범주형 데이터

##### 한 집단일 때

**일원 카이 제곱 검정**

:   one sample $x^2$ test, 적합성 검정에활용

```{r}
# 주사위를 60번 던져 때, 기대빈도와 관측빈도가 적합한지 검정
# 귀무가설: 기대빈도와 관측빈도는 차이가 없다
# 대립가설: 기대빈도와 관측빈도는 차이가 있다.

chisq.test(c(4,6,17,15,9,9), p = rep(1/6, 6))
```

p값에 따라 유의수준 0.05에서 귀무가설을 기각하고 대립가설을 채택한다. 즉 주사위의 기대빈도와 관측빈도에는 차이가 있다고 판단할 수 있다.

```{r}
# 통신 3사 점유율 차이 40%, 30%, 30%인지 검정
chisq.test(c(45, 30, 25), p = c(0.4, 0.3, 0.3))
```

##### 두 집단일 때

**이원 카이 제곱 검정**

```{r}
if(!require(palmerpenguins)) { install.packages("palmerpenguins"); library(palmerpenguins); }
chisq.test(x=penguins$species, y=penguins$island)
```

```{r}
if(!require(gmodels)) { install.packages("gmodels"); library(gmodels); }

CrossTable(x=penguins$species, y=penguins$island, chisq = T)
```

##### 피셔 정확 검정

분할표를 그린 뒤 카이 제곱을 적용할 때 표본 수가 적거나 표본이 분팔표의 셀에 매우 치우치게 분포되어 있다면 카이 제곱 검정의 결과가 부정확할 수 있다. 기대 빈도가 5 이하인 셀이 전체의 20% 수준일 때 표본의 수가 적다고 볼 수 있다. 이런 경우 Fisher's Exact Test를 적용한다.

```{r}
if(!require(MASS)) { install.packages("MASS"); library(MASS); }

xtabs( ~ W.Hnd + Clap, data = survey)
```

```{r}
chisq.test(survey$W.Hnd, survey$Clap)
```

```{r}
fisher.test(survey$W.Hnd, survey$Clap)
```

##### 맥니마 검정 (McNemar Test)

사건 전후의 차이 검정에 활용된다.

```{r}
Performance <-
   matrix(c(794, 86, 150, 570),
          nrow = 2,
          dimnames = list(
          "1st Survey" = c("Approve", "Disapprove"),
          "2nd Survey" = c("Approve", "Disapprove")))
Performance
```

```{r}
mcnemar.test(Performance)
```

p값에 따라 첫번째 조사와 두번째 조사 간에는 유의확률 0.05 하에서 통계적으로 유의미한 차이가 있다.

참고로, 사건 전후의 차이 검정은 b=c를 검토하여 변화 여부를 판단할 수 있다. $$b \sim B(b+c, \frac{1}{2})$$

따라서 위 예제의 경우 86 \~ B(86+150, 1/2)를 검토한다.

```{r}
binom.test(86, 86+150, 0.5)
```

#### 연속형 데이터

##### 정규성 검정

###### shapiro.test()

```{r}
shapiro.test(rnorm(1000))
```

###### ks.test()

콜모고로프 스미르노프 검정(Kolmogorov-Smirnov Test), 두 숫자 벡터 간의 차이가 없는지를 검정한다.

```{r}
ks.test(rnorm(100), rnorm(100))
```

```{r}
ks.test(rnorm(100), runif(100))
```

x를 정규분포에서 추출하였는지 검정을 할 수도 있다.

```{r}
ks.test(rnorm(1000), "pnorm", 0 ,1)
```

```{r}
ks.test(runif(1000), "pnorm", c(0, 1))
```

###### qqplot()

```{r}
x <- rnorm(1000, mean = 10, sd = 1)
qqnorm(x); qqline(x, lty=2, col = "blue")
```

```{r}
x <- runif(1000)
qqnorm(x); qqline(x, lty=2, col = "red")
```

```{r}
qqplot(runif(1000, min=1, max=10), 1:10)
```

```{r}
qqplot(rnorm(1000), 1:1000)
```

##### 한 집단일 때

###### one sample t-test

####### 정규성을 만족할 경우 t.test()

####### 정규성을 만족하지 못할 경우 wilcox.test(), Wilcoxon signed rank test

##### 두 집단일 때

###### independent two sample t-test

####### 정규성을 만족할 경우 t.test()

####### 정규성을 만족하지 못할 경우 wilcox.test(), Wilcoxon rank sum test

###### paired two sample t-test

####### 정규성을 만족할 경우 t.test()

####### 정규성을 만족하지 못할 경우 wilcox.test(), Wilcoxon signed rank test with paired

##### 세 집단 이상일 때

####### 정규성을 만족할 경우 aov()

####### 정규성을 만족하지 못할 경우 kruskal()

####### 사후검정

Fisher's LSD, Bonferroni, Shelf, Turkey, Duncan 등

### 비율검정

#### 일표본 binom.test()

#### 이표본 prop.test()

### 동질성 검사

#### 이표본 var.test()

#### 삼표본 이상 bartlett.test()

## TIL20220322

### 비모수 검정

```{r}
if(!require(moonBook)) { install.packages("moonBook"); library(moonBook); }
if(!require(palmerpenguins)) { install.packages("palmerpenguins"); library(palmerpenguins); }
data <- penguins
densityplot(body_mass_g ~ sex, data = data)
```

0.  정규성 검정

```{r}
shapiro.test(data$body_mass_g)
```

1.  Wilcoxon Rank Sum Test

```{r}
wilcox.result <- wilcox.test(body_mass_g ~ sex, data); wilcox.result
```

2.  Kruskal-Wallis Rank Sun Test

```{r}
kruskal.result <- kruskal.test(body_mass_g ~ species, data); kruskal.result
```

3.  다중비교 mctp in nparcomp package

```{r}
if(!require(nparcomp)) { install.packages("nparcomp"); library(nparcomp); }
mctp(body_mass_g ~ species, data)
```

### ANOVA in R

#### ANOVA 가정 점검

```{r}
if(!require(dplyr)) { install.packages("dplyr"); library(dplyr); }
if(!require(palmerpenguins)) { install.packages("palmerpenguins"); library(palmerpenguins); }
if(!require(ggplot2)) { install.packages("ggplot2"); library(ggplot2); }

data <- penguins %>% select(body_mass_g, species, sex) %>% na.omit()

ggplot(data, aes(species, body_mass_g, col=sex)) +
  geom_boxplot() +
  theme_bw()
```

펭귄 종에 따른 몸무게의 유의한 차이가 있는지 ANOVA로 분석한다. 신뢰성 있는 결과 도출을 위해 아래의 가정을 확인한다.

-   변수 유형 독립변수 범주형, 종속변수 연속형

```{r}
str(data)
```

-   독립성, *durbinWatsonTest()* 함수를 통해 통계적으로 검정

```{r}
if(!require(car)) { install.packages("car"); library(car); }

data.aov <- aov(body_mass_g ~ species, data)
durbinWatsonTest(data.aov)
```

-   정규성

    -   Shapiro-Wilk normality test
    -   Kolmogorov-Smirnov test
    -   QQPlot, Histogram

    ```{r}
    # Shapiro-Wilk normality test
    shapiro.test(data.aov$residuals)
    ```

```{r}
# Kolmogorov-Smirnov test
ks.test(x = data$species, y = data$body_mass_g)
```

```{r}
# QQPlot, Histogram
qqPlot(data.aov)
```

-   등분산성
    -   Levene's test
    -   Bartlette test
    -   Boxplot

```{r}
leveneTest(body_mass_g ~ species, data)
```

```{r}
leveneTest(body_mass_g ~ species*sex, data)
```

```{r}
bartlett.test(body_mass_g ~ species, data)
```

```{r}
bartlett.test(body_mass_g ~ interaction(species,sex), data)
```

-   이상치
    -   Boxplot, outlierTest()

```{r}
outlierTest(data.aov)
```

```{r}
range(data$body_mass_g); data[164,]
```

#### ANOVA

-   oneway.test(..., var.equal=)

```{r}
oneway.result <- oneway.test(body_mass_g ~ species, data, var.equal = F); oneway.result
```

-   aov()

```{r}
aov.result <- aov(body_mass_g ~ species, data)
summary(aov.result)
```

-   Kruskal-Wallis test (정규성 불만족 시)

```{r}
kruskal.test(body_mass_g ~ species, data)
```

#### 사후검정

-   Tukey HSD

```{r}
TukeyHSD(aov.result)
```

```{r}
if(!require(multcomp)) { install.packages("multcomp"); library(multcomp); }
tukey.result <- glht(aov.result, 
                       linfct = mcp(species = "Tukey")); tukey.result
```

```{r}
plot(tukey.result, las=1)
```

-   Dunnett

```{r}
if(!require(multcomp)) { install.packages("multcomp"); library(multcomp); }
dunnett.result <- glht(aov.result, 
                       linfct = mcp(species = "Dunnett")); dunnett.result
```

-   Bonferroni correction

```{r}
pairwise.t.test(data$body_mass_g, data$species, p.adjust.method = "bonferroni")
```

## TIL20220323

### 히트맵 in R

```{r}
if(!require(palmerpenguins)) { install.packages("palmerpenguins"); library(palmerpenguins); }
data <- penguins

data.matrix <- as.matrix(cor(data[,3:6], use="complete.obs"))
```

#### heatmap() in base

```{r}
if(!require(reshape2)) { install.packages("reshape2"); library(reshape2); }

heatmap(data.matrix, Rowv = NA, Colv = NA)

```

#### heatmap.2() in gplots

```{r}
if(!require(gplots)) { install.packages("gplots"); library(gplots); }
heatmap.2(data.matrix, Rowv = NA, Colv = NA, )
```

#### geom_tile() in ggplot2

```{r}
if(!require(reshape2)) { install.packages("reshape2"); library(reshape2); }
if(!require(ggplot2)) { install.packages("ggplot2"); library(ggplot2); }


data.melted <- melt(data.matrix); head(data.melted)

ggplot(data.melted, aes(x=Var1, y=Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient2(low="red", mid = "white", high="blue") +
  guides(fill = guide_colorbar(barwidth = .5, barheight = 15))
```

## TIL20220324

### 기계학습 모델링 with Caret

1.  데이터 준비
2.  데이터 탐색
3.  데이터 전처리
4.  데이터 분할
5.  모델 학습
6.  예측 및 성능평가
7.  모델 개선

```{r}
# 데이터 준비
if(!require(dplyr)) { install.packages("dplyr"); library(dplyr); }
if(!require(caret)) { install.packages("caret"); library(caret); }
if(!require(ggplot2)) { install.packages("ggplot2"); library(ggplot2); }
if(!require(mlbench)) { install.packages("mlbench"); library(mlbench); }
data <- BreastCancer
```


```{r}
# 데이터 탐색
str(data)
```


```{r}
summary(data)
```

```{r}
colSums(is.na(data))
```

```{r}
table(data$Class)
```


```{r}
# 데이터 전처리
if(!require(dplyr)) { install.packages("dplyr"); library(dplyr); }

data <- data %>% select(-Id) # 필요한 컬럼 제외
data <- data %>% na.omit() # 결측치 제외 (16/699이므로)
```


```{r}
# 데이터 분할
if(!require(caret)) { install.packages("caret"); library(caret); }

train.index <- createDataPartition(data$Class, p=.7, list=F)
data.train <- data[train.index, ]
data.test <- data[-train.index, ]
```


```{r}
# 모델 학습
trCtrl.up <- trainControl(sampling = "up")
trCtrl.down <- trainControl(sampling = "down")

model.dt.up <- train(Class ~ ., data = data.train, method = "rpart", trControl = trCtrl.up)
model.dt.down <- train(Class ~ ., data = data.train, method = "rpart", trControl = trCtrl.down)

model.list <- list(up = model.dt.up, down = model.dt.down)
model.resamples <- resamples(model.list)
dotplot(model.resamples)
```


```{r}
# 예측 및 성능평가
model.dt.up.pred <- predict(model.dt.up, data.test)
model.dt.down.pred <- predict(model.dt.down, data.test)
rbind(up = mean(model.dt.up.pred == data.test$Class),
      down = mean(model.dt.down.pred == data.test$Class) )
```

```{r}
if(!require(pROC)) { install.packages("pROC"); library(pROC); }
model.dt.up.pred <- predict(model.dt.up, data.test, type = "prob")
model.dt.down.pred <- predict(model.dt.down, data.test, type = "prob")
roc(data.test$Class, model.dt.up.pred[,1], plot=T, print.auc=T, col="red")
roc(data.test$Class, model.dt.down.pred[,1], plot=T, print.auc=T, add=T, col="blue", print.auc.adj=c(0,-1))
text(1.2, 0.8, "Blue: Down sampling\nRed: Up sampling")
```
### 다중범주 ROC

```{r}
if(!require(rpart)) { install.packages("rpart"); library(rpart); }
data <- penguins
data <- na.omit(data)
set.seed(1234)
train.index <- sample(nrow(data), 0.7*nrow(data), replace=F) 
train <- data[train.index,]
test <- data[-train.index,]
model.dt <- rpart(species ~ ., train)
model.dt.pred <- predict(model.dt, test, type="class")

if(!require(pROC)) { install.packages("pROC"); library(pROC); }
mroc <- multiclass.roc(test$species, as.numeric(model.dt.pred))
pROC::plot.roc(mroc$rocs[[1]], plot=T, col=1, print.auc=T)
for(i in 2:3) {
  pROC::plot.roc(mroc$rocs[[i]], plot=T, col=i, print.auc=T, add=T,
                 print.auc.adj = c(0,i))
}
```

## TIL20220325



